
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Leads CRM - Professional Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .hover-scale {
            transition: transform 0.2s;
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-new { background-color: #dbeafe; color: #1e40af; }
        .status-in-progress { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-pending { background-color: #cffafe; color: #155e75; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .status-completed { background-color: #dcfce7; color: #166534; }
        
        .loan-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .loan-home { background-color: #dbeafe; color: #1e40af; }
        .loan-personal { background-color: #d1fae5; color: #065f46; }
        .loan-business { background-color: #fed7aa; color: #9a3412; }
        .loan-car { background-color: #e9d5ff; color: #6b21a8; }
        .loan-education { background-color: #ccfbf1; color: #134e4a; }
        
        .metric-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: white;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid #d1d5db;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        
        .btn-whatsapp {
            background: #25d366;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-whatsapp:hover {
            background: #128c7e;
            transform: translateY(-1px);
        }
        
        .btn-call {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-call:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-document {
            background: #8b5cf6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-document:hover {
            background: #7c3aed;
            transform: translateY(-1px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-in;
        }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
            gap: 0.75rem;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.show {
            display: flex;
        }
        
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
        
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.sidebar-open {
            margin-left: 250px;
        }
        
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 250px;
            }
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 0.75rem;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .call-modal {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1500;
            min-width: 300px;
        }
        
        .call-modal.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        .call-animation {
            display: inline-block;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            position: relative;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .dial-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .dial-button {
            aspect-ratio: 1;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .dial-button:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
            transform: scale(1.05);
        }
        
        .dial-button:active {
            transform: scale(0.95);
        }
        
        .dial-button .letters {
            font-size: 0.5rem;
            color: #6b7280;
            margin-top: 0.125rem;
        }
        
        .dial-display {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            font-size: 1.25rem;
            text-align: center;
            margin-bottom: 1rem;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-priority {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .priority-high { background-color: #fee2e2; color: #991b1b; }
        .priority-medium { background-color: #fef3c7; color: #92400e; }
        .priority-low { background-color: #dbeafe; color: #1e40af; }
        
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .file-upload-area.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .notification-badge {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background: #ef4444;
            color: white;
            border-radius: 9999px;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .commitment-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .commitment-met { background-color: #d1fae5; color: #065f46; }
        .commitment-pending { background-color: #fef3c7; color: #92400e; }
        .commitment-overdue { background-color: #fee2e2; color: #991b1b; }
        
        .document-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .document-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle text-green-500"></i>
        <span id="toastMessage">Operation successful!</span>
    </div>

    <!-- IVR Call Modal -->
    <div id="callModal" class="call-modal">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">IVR Call in Progress</h3>
            <button onclick="endCall()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="text-center mb-4">
            <div class="call-animation mx-auto mb-3 flex items-center justify-center">
                <i class="fas fa-phone text-white text-2xl"></i>
            </div>
            <p class="text-sm text-gray-600">Calling: <span id="callingNumber" class="font-semibold"></span></p>
            <p class="text-xs text-gray-500 mt-1">Duration: <span id="callDuration">00:00</span></p>
        </div>
        <div class="space-y-2">
            <button onclick="transferCall()" class="w-full btn-secondary text-sm">
                <i class="fas fa-phone-alt mr-2"></i>Transfer Call
            </button>
            <button onclick="recordCall()" class="w-full btn-secondary text-sm">
                <i class="fas fa-microphone mr-2"></i>Record Call
            </button>
            <button onclick="endCall()" class="w-full btn-call text-sm">
                <i class="fas fa-phone-slash mr-2"></i>End Call
            </button>
        </div>
    </div>

    <!-- Dial Pad Modal -->
    <div id="dialPadModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Dial Pad</h3>
                <button onclick="closeDialPad()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="dial-display" id="dialDisplay">
                Enter number
            </div>
            
            <div class="dial-pad">
                <button onclick="dialPadInput('1')" class="dial-button">
                    1
                    <span class="letters"></span>
                </button>
                <button onclick="dialPadInput('2')" class="dial-button">
                    2
                    <span class="letters">ABC</span>
                </button>
                <button onclick="dialPadInput('3')" class="dial-button">
                    3
                    <span class="letters">DEF</span>
                </button>
                <button onclick="dialPadInput('4')" class="dial-button">
                    4
                    <span class="letters">GHI</span>
                </button>
                <button onclick="dialPadInput('5')" class="dial-button">
                    5
                    <span class="letters">JKL</span>
                </button>
                <button onclick="dialPadInput('6')" class="dial-button">
                    6
                    <span class="letters">MNO</span>
                </button>
                <button onclick="dialPadInput('7')" class="dial-button">
                    7
                    <span class="letters">PQRS</span>
                </button>
                <button onclick="dialPadInput('8')" class="dial-button">
                    8
                    <span class="letters">TUV</span>
                </button>
                <button onclick="dialPadInput('9')" class="dial-button">
                    9
                    <span class="letters">WXYZ</span>
                </button>
                <button onclick="dialPadInput('*')" class="dial-button">
                    *
                </button>
                <button onclick="dialPadInput('0')" class="dial-button">
                    0
                    <span class="letters">+</span>
                </button>
                <button onclick="dialPadInput('#')" class="dial-button">
                    #
                </button>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="clearDialPad()" class="flex-1 btn-secondary">
                    <i class="fas fa-backspace mr-2"></i>Clear
                </button>
                <button onclick="makeDialPadCall()" class="flex-1 btn-call">
                    <i class="fas fa-phone mr-2"></i>Call
                </button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="taskModalTitle" class="text-xl font-semibold text-gray-900">Add New Task</h3>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="taskForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Title *</label>
                    <input type="text" id="taskTitle" class="form-input" required="">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="taskDescription" class="form-input" rows="3"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date *</label>
                        <input type="datetime-local" id="taskDueDate" class="form-input" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="taskPriority" class="form-input">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Assigned To</label>
                    <select id="taskAssignedTo" class="form-input">
                        <option value="">Select Agent</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reminder</label>
                    <select id="taskReminder" class="form-input">
                        <option value="none">No Reminder</option>
                        <option value="15">15 minutes before</option>
                        <option value="30">30 minutes before</option>
                        <option value="60">1 hour before</option>
                        <option value="1440">1 day before</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeTaskModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Client Documents Modal -->
    <div id="clientDocumentsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Client Documents</h3>
                <button onclick="closeClientDocumentsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Client: <span id="clientName" class="font-semibold"></span></p>
            </div>
            
            <div class="mb-6">
                <div class="file-upload-area" id="clientFileUploadArea" ondrop="handleClientFileDrop(event)" ondragover="handleClientFileDragOver(event)" ondragleave="handleClientFileDragLeave(event)">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600 mb-2">Drag and drop client documents here or click to browse</p>
                    <p class="text-sm text-gray-500">Supported formats: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (Max 5MB)</p>
                    <input type="file" id="clientFileInput" class="hidden" multiple="" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" onchange="handleClientFileSelect(event)">
                </div>
            </div>
            
            <div class="border rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-3">Uploaded Documents</h4>
                <div id="clientDocumentsList" class="document-list">
                    <!-- Client documents will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mb-4">
                    <i class="fas fa-building text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900">Loan Leads CRM</h1>
                <p class="text-gray-600 mt-2">Professional Management System</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-8">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <div class="relative">
                            <i class="fas fa-user absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="username" class="form-input pl-10" placeholder="Enter your username" required="">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                            <input type="password" id="password" class="form-input pl-10 pr-10" placeholder="Enter your password" required="">
                            <button type="button" id="togglePassword" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary">
                        <span id="loginButtonText">Sign In</span>
                        <div id="loginSpinner" class="loading-spinner mx-auto hidden"></div>
                    </button>
                </form>
                
                <div class="mt-6 text-sm text-gray-600">
                    <p class="font-medium mb-2">Demo Accounts:</p>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <p><strong>Admin:</strong> username: admin, password: admin123</p>
                        <p><strong>Agent:</strong> username: agent1, password: agent123</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="p-6 border-b">
                <div class="flex items-center">
                    <div class="h-8 w-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-md flex items-center justify-center mr-3">
                        <i class="fas fa-building text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">SVA CRM</h1>
                </div>
            </div>
            
            <nav class="p-4">
                <ul class="space-y-2">
                    <li>
                        <a href="#" data-page="dashboard" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                            <i class="fas fa-tachometer-alt w-5 mr-3"></i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="leads" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                            <i class="fas fa-users w-5 mr-3"></i>
                            Leads Management
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="tasks" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700 relative">
                            <i class="fas fa-tasks w-5 mr-3"></i>
                            Tasks
                            <span id="taskNotificationBadge" class="notification-badge hidden">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="callHistory" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                            <i class="fas fa-phone-alt w-5 mr-3"></i>
                            Call History
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="files" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                            <i class="fas fa-folder w-5 mr-3"></i>
                            Files
                        </a>
                    </li>
                    <li id="adminMenu" class="hidden">
                        <a href="#" data-page="admin" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                            <i class="fas fa-user-shield w-5 mr-3"></i>
                            Admin Panel
                        </a>
                    </li>
                    <li id="reportsMenu" class="hidden">
                        <a href="#" data-page="reports" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                            <i class="fas fa-chart-bar w-5 mr-3"></i>
                            Reports
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="profile" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                            <i class="fas fa-user w-5 mr-3"></i>
                            Profile
                        </a>
                    </li>
                    <li>
                        <a href="#" id="logoutBtn" class="flex items-center p-3 rounded-lg hover:bg-gray-100 text-red-600">
                            <i class="fas fa-sign-out-alt w-5 mr-3"></i>
                            Logout
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="mainContent" class="main-content">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b">
                <div class="px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center">
                            <button id="menuToggle" class="md:hidden mr-4 text-gray-600 hover:text-gray-900">
                                <i class="fas fa-bars text-xl"></i>
                            </button>
                            <h2 id="pageTitle" class="text-xl font-semibold text-gray-900">Dashboard</h2>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button onclick="showDialPad()" class="btn-call text-sm">
                                <i class="fas fa-phone mr-2"></i>Dial Pad
                            </button>
                            <div class="hidden md:block">
                                <div class="flex items-center space-x-2 text-sm">
                                    <span class="text-gray-500">Welcome,</span>
                                    <span id="userName" class="font-medium text-gray-900"></span>
                                    <span id="userRole" class="status-badge"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div id="pageContent" class="p-4 sm:p-6 lg:p-8">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page">
                    <!-- Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Leads</p>
                                    <p id="totalLeads" class="text-2xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Active Loans</p>
                                    <p id="activeLoans" class="text-2xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <div class="h-12 w-12 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Pending Tasks</p>
                                    <p id="pendingTasks" class="text-2xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <div class="h-12 w-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-clock text-yellow-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Amount</p>
                                    <p id="totalAmount" class="text-2xl font-bold text-gray-900 mt-1">₹0</p>
                                </div>
                                <div class="h-12 w-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-rupee-sign text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Leads -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Recent Leads</h3>
                            <button onclick="showAddLeadModal()" class="btn-primary">
                                <i class="fas fa-plus mr-2"></i>Add New Lead
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Loan Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recentLeadsTable">
                                    <!-- Leads will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Upcoming Tasks -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Upcoming Tasks</h3>
                            <button onclick="showTaskModal()" class="btn-primary">
                                <i class="fas fa-plus mr-2"></i>Add Task
                            </button>
                        </div>
                        
                        <div id="upcomingTasksList" class="space-y-3">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Tasks Page -->
                <div id="tasksPage" class="page hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Task Management</h3>
                            <button onclick="showTaskModal()" class="btn-primary">
                                <i class="fas fa-plus mr-2"></i>Add Task
                            </button>
                        </div>
                        
                        <div class="mb-6 flex flex-wrap gap-3">
                            <button onclick="filterTasks('all')" class="btn-secondary">All Tasks</button>
                            <button onclick="filterTasks('pending')" class="btn-secondary">Pending</button>
                            <button onclick="filterTasks('completed')" class="btn-secondary">Completed</button>
                            <button onclick="filterTasks('overdue')" class="btn-secondary">Overdue</button>
                        </div>
                        
                        <div id="tasksList" class="space-y-3">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Call History Page -->
                <div id="callHistoryPage" class="page hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Call History</h3>
                            <div class="flex gap-3">
                                <button onclick="clearCallHistory()" class="btn-secondary text-red-600">
                                    <i class="fas fa-trash mr-2"></i>Clear History
                                </button>
                                <button onclick="exportCallHistory()" class="btn-secondary">
                                    <i class="fas fa-download mr-2"></i>Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date &amp; Time</th>
                                        <th>Contact</th>
                                        <th>Duration</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="callHistoryTable">
                                    <!-- Call history will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Files Page -->
                <div id="filesPage" class="page hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">File Management</h3>
                            <button onclick="document.getElementById('fileInput').click()" class="btn-primary">
                                <i class="fas fa-upload mr-2"></i>Upload File
                            </button>
                        </div>
                        
                        <div class="file-upload-area mb-6" id="fileUploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 mb-2">Drag and drop files here or click to browse</p>
                            <p class="text-sm text-gray-500">Supported formats: PDF, DOC, DOCX, XLS, XLSX (Max 5MB)</p>
                            <input type="file" id="fileInput" class="hidden" multiple="" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="handleFileSelect(event)">
                        </div>
                        
                        <div id="uploadedFiles" class="space-y-3">
                            <!-- Uploaded files will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Leads Management Page -->
                <div id="leadsPage" class="page hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h3 class="text-lg font-semibold text-gray-900">All Leads</h3>
                            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                                <div class="relative">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                    <input type="text" id="searchLeads" class="form-input pl-10" placeholder="Search leads...">
                                </div>
                                <button onclick="showAddLeadModal()" class="btn-primary">
                                    <i class="fas fa-plus mr-2"></i>Add Lead
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Loan Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allLeadsTable">
                                    <!-- Leads will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel Page -->
                <div id="adminPage" class="page hidden">
                    <!-- Admin Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Agents</p>
                                    <p id="totalAgents" class="text-2xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Active Agents</p>
                                    <p id="activeAgents" class="text-2xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <div class="h-12 w-12 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-check text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Leads Assigned</p>
                                    <p id="leadsAssigned" class="text-2xl font-bold text-gray-900 mt-1">0</p>
                                </div>
                                <div class="h-12 w-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-tasks text-yellow-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Conversion Rate</p>
                                    <p id="conversionRate" class="text-2xl font-bold text-gray-900 mt-1">0%</p>
                                </div>
                                <div class="h-12 w-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Management -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Agent Management</h3>
                            <button onclick="showAddAgentModal()" class="btn-primary">
                                <i class="fas fa-user-plus mr-2"></i>Add Agent
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Username</th>
                                        <th>Contact</th>
                                        <th>Status</th>
                                        <th>Performance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsTable">
                                    <!-- Agents will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Leads Management for Admin -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">All Leads Management</h3>
                            <div class="flex gap-3">
                                <button onclick="exportLeads()" class="btn-secondary">
                                    <i class="fas fa-download mr-2"></i>Export Leads
                                </button>
                                <button onclick="bulkDeleteLeads()" class="btn-secondary text-red-600">
                                    <i class="fas fa-trash mr-2"></i>Bulk Delete
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllLeads" onchange="toggleSelectAllLeads()">
                                        </th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Loan Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminLeadsTable">
                                    <!-- Leads will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reportsPage" class="page hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Daily Worksheet Report -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Worksheet Report</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Agent</label>
                                    <select id="reportAgent" class="form-input">
                                        <option value="">All Agents</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                                    <input type="date" id="reportDate" class="form-input">
                                </div>
                                
                                <button onclick="generateDailyReport()" class="w-full btn-primary">
                                    <i class="fas fa-file-alt mr-2"></i>Generate Report
                                </button>
                            </div>
                            
                            <div id="dailyReportContent" class="mt-6 hidden">
                                <!-- Report content will be populated here -->
                            </div>
                        </div>

                        <!-- Commitment Tracking -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Commitment Tracking</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Add Commitment</label>
                                    <input type="text" id="commitmentTitle" class="form-input" placeholder="Commitment title">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Amount (₹)</label>
                                    <input type="number" id="commitmentAmount" class="form-input" placeholder="0">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                    <input type="date" id="commitmentDueDate" class="form-input">
                                </div>
                                
                                <button onclick="addCommitment()" class="w-full btn-primary">
                                    <i class="fas fa-plus mr-2"></i>Add Commitment
                                </button>
                            </div>
                            
                            <div id="commitmentsList" class="mt-6 space-y-3">
                                <!-- Commitments will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Performance Reports -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Performance Reports</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <button onclick="generatePerformanceReport('weekly')" class="btn-secondary">
                                <i class="fas fa-calendar-week mr-2"></i>Weekly Report
                            </button>
                            <button onclick="generatePerformanceReport('monthly')" class="btn-secondary">
                                <i class="fas fa-calendar-alt mr-2"></i>Monthly Report
                            </button>
                            <button onclick="generatePerformanceReport('custom')" class="btn-secondary">
                                <i class="fas fa-calendar mr-2"></i>Custom Range
                            </button>
                        </div>
                        
                        <div id="performanceReportContent" class="hidden">
                            <!-- Performance report content will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profilePage" class="page hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Profile Card -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="text-center">
                                    <div class="h-24 w-24 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span id="profileInitials" class="text-2xl font-bold text-white"></span>
                                    </div>
                                    <h3 id="profileName" class="text-xl font-semibold text-gray-900"></h3>
                                    <p id="profileEmail" class="text-gray-600 mt-1"></p>
                                    <div class="flex justify-center mt-3">
                                        <span id="profileRole" class="status-badge"></span>
                                    </div>
                                </div>
                                
                                <div class="mt-6 space-y-3">
                                    <div class="flex items-center text-sm">
                                        <i class="fas fa-envelope w-5 text-gray-400 mr-3"></i>
                                        <span id="profileEmailDetail"></span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <i class="fas fa-phone w-5 text-gray-400 mr-3"></i>
                                        <span id="profilePhone"></span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <i class="fas fa-calendar w-5 text-gray-400 mr-3"></i>
                                        <span>Joined January 15, 2023</span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <i class="fas fa-shield-alt w-5 text-gray-400 mr-3"></i>
                                        <span>Account verified</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Settings -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-6">Profile Settings</h3>
                                
                                <form id="profileForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <div class="relative">
                                            <i class="fas fa-user absolute left-3 top-3 text-gray-400"></i>
                                            <input type="text" id="profileNameInput" class="form-input pl-10" required="">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                        <div class="relative">
                                            <i class="fas fa-envelope absolute left-3 top-3 text-gray-400"></i>
                                            <input type="email" id="profileEmailInput" class="form-input pl-10" required="">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                        <div class="relative">
                                            <i class="fas fa-phone absolute left-3 top-3 text-gray-400"></i>
                                            <input type="tel" id="profilePhoneInput" class="form-input pl-10" required="">
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn-primary">
                                        <i class="fas fa-save mr-2"></i>Update Profile
                                    </button>
                                </form>
                                
                                <hr class="my-6">
                                
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Change Password</h3>
                                
                                <form id="passwordForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                        <div class="relative">
                                            <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                                            <input type="password" id="currentPassword" class="form-input pl-10" required="">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                        <div class="relative">
                                            <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                                            <input type="password" id="newPassword" class="form-input pl-10" required="">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                        <div class="relative">
                                            <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                                            <input type="password" id="confirmPassword" class="form-input pl-10" required="">
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn-primary">
                                        <i class="fas fa-key mr-2"></i>Change Password
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="leadModalTitle" class="text-xl font-semibold text-gray-900">Add New Lead</h3>
                <button onclick="closeLeadModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="leadForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name&nbsp;</label>
                        <input type="text" id="leadName" class="form-input" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company name&nbsp;</label>
                        <input type="text" id="leadName" class="form-input" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                        <input type="tel" id="leadPhone" class="form-input" placeholder="+91XXXXXXXXXX" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loan Amount (₹)&nbsp;</label>
                        <input type="number" id="leadAmount" class="form-input" min="0" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loan Type</label>
                        <select id="leadType" class="form-input">
                            <option value="home">Home Loan</option>
                            <option value="personal">Personal Loan</option>
                            <option value="business">Business Loan</option>
                            <option value="car">Car Loan</option>
                            <option value="education">Education Loan</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="leadStatus" class="form-input">
                            <option value="new">New</option>
                            <option value="in-progress">In Progress</option>
                            <option value="approved">Approved</option>
                            <option value="pending">Pending</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div id="agentAssignField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Agent</label>
                        <select id="leadAgent" class="form-input">
                            <option value="">Select Agent</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="leadNotes" class="form-input" rows="4" placeholder="Add any additional notes..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeLeadModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Lead
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Agent Modal -->
    <div id="agentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="agentModalTitle" class="text-xl font-semibold text-gray-900">Add New Agent</h3>
                <button onclick="closeAgentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="agentForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                        <input type="text" id="agentName" class="form-input" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                        <input type="text" id="agentUsername" class="form-input" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" id="agentEmail" class="form-input" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                        <input type="tel" id="agentPhone" class="form-input" placeholder="+91XXXXXXXXXX" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" id="agentPassword" class="form-input" required="">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="agentStatus" class="form-input">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAgentModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Agent
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let leads = [];
        let agents = [];
        let tasks = [];
        let commitments = [];
        let uploadedFiles = [];
        let clientDocuments = [];
        let callHistory = [];
        let editingLead = null;
        let editingAgent = null;
        let editingTask = null;
        let currentClientLead = null;
        let callTimer = null;
        let callStartTime = null;
        let currentCall = null;
        let dialPadNumber = '';

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadSampleData();
            startTaskReminderChecker();
        });

        function initializeApp() {
            // Check if user is logged in
            const storedUser = localStorage.getItem('crm_user');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Toggle password visibility
            document.getElementById('togglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const icon = this.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    navigateToPage(page);
                });
            });
            
            // Mobile menu toggle
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('open');
                document.getElementById('mainContent').classList.toggle('sidebar-open');
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Lead form
            document.getElementById('leadForm').addEventListener('submit', handleLeadSubmit);
            
            // Agent form
            document.getElementById('agentForm').addEventListener('submit', handleAgentSubmit);
            
            // Task form
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            
            // Profile form
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            
            // Password form
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
            
            // Search leads
            document.getElementById('searchLeads').addEventListener('input', function() {
                filterLeads(this.value);
            });
            
            // File upload area click
            document.getElementById('fileUploadArea').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            // Client file upload area click
            document.getElementById('clientFileUploadArea').addEventListener('click', function() {
                document.getElementById('clientFileInput').click();
            });
        }

        function loadSampleData() {
            // Load sample leads
            const storedLeads = localStorage.getItem('crm_leads');
            if (storedLeads) {
                leads = JSON.parse(storedLeads);
            } else {
                leads = [
                    {
                        id: 1,
                        customerName: 'Rahul Sharma',
                        email: 'rahul.sharma@email.com',
                        phone: '+919876543210',
                        loanType: 'home',
                        loanAmount: 5000000,
                        status: 'approved',
                        createdDate: new Date('2024-01-15').toISOString(),
                        notes: 'Looking for a home loan in Mumbai',
                        assignedTo: 'agent1'
                    },
                    {
                        id: 2,
                        customerName: 'Priya Patel',
                        email: 'priya.patel@email.com',
                        phone: '+919812345678',
                        loanType: 'personal',
                        loanAmount: 1000000,
                        status: 'in-progress',
                        createdDate: new Date('2024-01-18').toISOString(),
                        notes: 'Personal loan for wedding expenses',
                        assignedTo: 'agent2'
                    },
                    {
                        id: 3,
                        customerName: 'Amit Kumar',
                        email: 'amit.kumar@email.com',
                        phone: '+919823456789',
                        loanType: 'business',
                        loanAmount: 2500000,
                        status: 'pending',
                        createdDate: new Date('2024-01-20').toISOString(),
                        notes: 'Business expansion loan required',
                        assignedTo: null
                    }
                ];
                localStorage.setItem('crm_leads', JSON.stringify(leads));
            }
            
            // Load sample agents
            const storedAgents = localStorage.getItem('crm_agents');
            if (storedAgents) {
                agents = JSON.parse(storedAgents);
            } else {
                agents = [
                    {
                        id: 1,
                        name: 'Agent One',
                        username: 'agent1',
                        email: 'agent1@loanleads.com',
                        phone: '+919812345678',
                        role: 'agent',
                        status: 'active',
                        joinDate: '2023-01-15',
                        leadsAssigned: 24,
                        leadsConverted: 18
                    },
                    {
                        id: 2,
                        name: 'Agent Two',
                        username: 'agent2',
                        email: 'agent2@loanleads.com',
                        phone: '+919823456789',
                        role: 'agent',
                        status: 'active',
                        joinDate: '2023-02-20',
                        leadsAssigned: 32,
                        leadsConverted: 22
                    }
                ];
                localStorage.setItem('crm_agents', JSON.stringify(agents));
            }
            
            // Load sample tasks
            const storedTasks = localStorage.getItem('crm_tasks');
            if (storedTasks) {
                tasks = JSON.parse(storedTasks);
            } else {
                tasks = [
                    {
                        id: 1,
                        title: 'Follow up with Rahul Sharma',
                        description: 'Discuss home loan application status',
                        dueDate: new Date(Date.now() + 86400000).toISOString(),
                        priority: 'high',
                        assignedTo: 'agent1',
                        status: 'pending',
                        reminder: 60,
                        createdBy: 'admin'
                    },
                    {
                        id: 2,
                        title: 'Prepare documents for Priya Patel',
                        description: 'Gather all required documents for personal loan',
                        dueDate: new Date(Date.now() + 172800000).toISOString(),
                        priority: 'medium',
                        assignedTo: 'agent2',
                        status: 'pending',
                        reminder: 30,
                        createdBy: 'admin'
                    }
                ];
                localStorage.setItem('crm_tasks', JSON.stringify(tasks));
            }
            
            // Load sample commitments
            const storedCommitments = localStorage.getItem('crm_commitments');
            if (storedCommitments) {
                commitments = JSON.parse(storedCommitments);
            } else {
                commitments = [
                    {
                        id: 1,
                        title: 'Monthly Target - January',
                        targetAmount: 10000000,
                        currentAmount: 7500000,
                        dueDate: new Date('2024-01-31').toISOString(),
                        status: 'pending',
                        assignedTo: 'all'
                    }
                ];
                localStorage.setItem('crm_commitments', JSON.stringify(commitments));
            }
            
            // Load call history
            const storedCallHistory = localStorage.getItem('crm_callHistory');
            if (storedCallHistory) {
                callHistory = JSON.parse(storedCallHistory);
            } else {
                callHistory = [];
            }
            
            // Load uploaded files
            const storedFiles = localStorage.getItem('crm_files');
            if (storedFiles) {
                uploadedFiles = JSON.parse(storedFiles);
            } else {
                uploadedFiles = [];
            }
            
            // Load client documents
            const storedClientDocuments = localStorage.getItem('crm_clientDocuments');
            if (storedClientDocuments) {
                clientDocuments = JSON.parse(storedClientDocuments);
            } else {
                clientDocuments = [];
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Show loading state
            document.getElementById('loginButtonText').classList.add('hidden');
            document.getElementById('loginSpinner').classList.remove('hidden');
            
            // Simulate API call
            setTimeout(() => {
                // Check against stored agents
                const foundAgent = agents.find(a => a.username === username && password === 'agent123');
                
                // Mock admin login
                if (username === 'admin' && password === 'admin123') {
                    currentUser = { 
                        id: 0, 
                        username: 'admin', 
                        name: 'Admin User', 
                        role: 'admin',
                        email: 'admin@loanleads.com',
                        phone: '+919876543210'
                    };
                    localStorage.setItem('crm_user', JSON.stringify(currentUser));
                    showToast('Login successful! Welcome back, Admin', 'success');
                    showMainApp();
                } else if (foundAgent) {
                    currentUser = foundAgent;
                    localStorage.setItem('crm_user', JSON.stringify(currentUser));
                    showToast('Login successful! Welcome back, ' + foundAgent.name, 'success');
                    showMainApp();
                } else {
                    showToast('Invalid username or password', 'error');
                }
                
                // Reset loading state
                document.getElementById('loginButtonText').classList.remove('hidden');
                document.getElementById('loginSpinner').classList.add('hidden');
            }, 1000);
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('crm_user');
            showToast('You have been logged out', 'success');
            showLoginPage();
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            document.getElementById('userRole').className = `status-badge ${currentUser.role === 'admin' ? 'status-approved' : 'status-new'}`;
            
            // Show admin menu if user is admin
            if (currentUser.role === 'admin') {
                document.getElementById('adminMenu').classList.remove('hidden');
                document.getElementById('reportsMenu').classList.remove('hidden');
            }
            
            // Update profile page
            updateProfilePage();
            
            // Load dashboard
            navigateToPage('dashboard');
        }

        function navigateToPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(page + 'Page').classList.remove('hidden');
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                leads: 'Leads Management',
                tasks: 'Task Management',
                callHistory: 'Call History',
                files: 'File Management',
                admin: 'Admin Panel',
                reports: 'Reports',
                profile: 'My Profile'
            };
            document.getElementById('pageTitle').textContent = titles[page];
            
            // Update active sidebar link
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('bg-blue-50', 'text-blue-600');
                if (link.dataset.page === page) {
                    link.classList.add('bg-blue-50', 'text-blue-600');
                }
            });
            
            // Load page-specific data
            if (page === 'dashboard') {
                loadDashboardData();
            } else if (page === 'leads') {
                loadAllLeads();
            } else if (page === 'tasks') {
                loadTasks();
            } else if (page === 'callHistory') {
                loadCallHistory();
            } else if (page === 'files') {
                loadFiles();
            } else if (page === 'admin') {
                loadAdminData();
            } else if (page === 'reports') {
                loadReportsData();
            }
            
            // Close mobile menu
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('mainContent').classList.remove('sidebar-open');
            }
        }

        function loadDashboardData() {
            // Calculate metrics
            const totalLeads = leads.length;
            const activeLoans = leads.filter(l => l.status === 'approved').length;
            const pendingTasks = tasks.filter(t => t.status === 'pending').length;
            const totalAmount = leads.reduce((sum, l) => sum + l.loanAmount, 0);
            
            // Update metrics
            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('activeLoans').textContent = activeLoans;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            document.getElementById('totalAmount').textContent = '₹' + totalAmount.toLocaleString('en-IN');
            
            // Load recent leads (last 5)
            const recentLeads = [...leads].sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate)).slice(0, 5);
            renderLeadsTable('recentLeadsTable', recentLeads, false);
            
            // Load upcoming tasks
            loadUpcomingTasks();
        }

        function loadUpcomingTasks() {
            const upcomingTasksList = document.getElementById('upcomingTasksList');
            const userTasks = currentUser.role === 'admin' 
                ? tasks 
                : tasks.filter(t => t.assignedTo === currentUser.username || t.assignedTo === 'all');
            
            const upcomingTasks = userTasks
                .filter(t => t.status === 'pending')
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 5);
            
            if (upcomingTasks.length === 0) {
                upcomingTasksList.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming tasks</p>';
                return;
            }
            
            upcomingTasksList.innerHTML = upcomingTasks.map(task => `
                <div class="border rounded-lg p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${task.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${task.description}</p>
                            <div class="flex items-center gap-3 mt-2">
                                <span class="task-priority priority-${task.priority}">${task.priority}</span>
                                <span class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${new Date(task.dueDate).toLocaleString()}
                                </span>
                            </div>
                        </div>
                        <button onclick="completeTask(${task.id})" class="btn-secondary text-sm">
                            <i class="fas fa-check mr-1"></i>Complete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadTasks() {
            const tasksList = document.getElementById('tasksList');
            const userTasks = currentUser.role === 'admin' 
                ? tasks 
                : tasks.filter(t => t.assignedTo === currentUser.username || t.assignedTo === 'all');
            
            if (userTasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500 text-center py-8">No tasks found</p>';
                return;
            }
            
            tasksList.innerHTML = userTasks.map(task => {
                const isOverdue = new Date(task.dueDate) < new Date() && task.status === 'pending';
                const statusClass = task.status === 'completed' ? 'status-completed' : 
                                  isOverdue ? 'status-rejected' : 'status-pending';
                
                return `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h4 class="font-medium text-gray-900">${task.title}</h4>
                                    <span class="status-badge ${statusClass}">${task.status}</span>
                                    ${isOverdue ? '<span class="status-badge status-rejected">Overdue</span>' : ''}
                                </div>
                                <p class="text-sm text-gray-600 mb-3">${task.description}</p>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <span class="task-priority priority-${task.priority}">${task.priority}</span>
                                    <span><i class="fas fa-clock mr-1"></i>${new Date(task.dueDate).toLocaleString()}</span>
                                    <span><i class="fas fa-user mr-1"></i>${task.assignedTo}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${task.status !== 'completed' ? `
                                    <button onclick="completeTask(${task.id})" class="action-btn btn-secondary" title="Complete">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                                <button onclick="editTask(${task.id})" class="action-btn btn-secondary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteTask(${task.id})" class="action-btn btn-secondary text-red-600" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterTasks(filter) {
            const allTasks = document.querySelectorAll('#tasksList > div');
            allTasks.forEach(taskEl => {
                if (filter === 'all') {
                    taskEl.style.display = 'block';
                } else {
                    const statusText = taskEl.querySelector('.status-badge').textContent.toLowerCase();
                    if (statusText.includes(filter)) {
                        taskEl.style.display = 'block';
                    } else {
                        taskEl.style.display = 'none';
                    }
                }
            });
        }

        function showTaskModal() {
            editingTask = null;
            document.getElementById('taskModalTitle').textContent = 'Add New Task';
            document.getElementById('taskForm').reset();
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('taskDueDate').value = tomorrow.toISOString().slice(0, 16);
            
            // Populate agent select
            populateTaskAgentSelect();
            
            document.getElementById('taskModal').classList.add('active');
        }

        function populateTaskAgentSelect() {
            const select = document.getElementById('taskAssignedTo');
            select.innerHTML = '<option value="">Select Agent</option>';
            
            if (currentUser.role === 'admin') {
                select.innerHTML += '<option value="all">All Agents</option>';
                agents.filter(a => a.status === 'active').forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.username;
                    option.textContent = agent.name;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = currentUser.username;
                option.textContent = currentUser.name;
                select.appendChild(option);
            }
        }

        function editTask(id) {
            editingTask = tasks.find(t => t.id === id);
            if (editingTask) {
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                document.getElementById('taskTitle').value = editingTask.title;
                document.getElementById('taskDescription').value = editingTask.description;
                document.getElementById('taskDueDate').value = new Date(editingTask.dueDate).toISOString().slice(0, 16);
                document.getElementById('taskPriority').value = editingTask.priority;
                document.getElementById('taskReminder').value = editingTask.reminder || 'none';
                
                populateTaskAgentSelect();
                document.getElementById('taskAssignedTo').value = editingTask.assignedTo;
                
                document.getElementById('taskModal').classList.add('active');
            }
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            editingTask = null;
        }

        function handleTaskSubmit(e) {
            e.preventDefault();
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                dueDate: new Date(document.getElementById('taskDueDate').value).toISOString(),
                priority: document.getElementById('taskPriority').value,
                assignedTo: document.getElementById('taskAssignedTo').value || currentUser.username,
                reminder: document.getElementById('taskReminder').value,
                status: 'pending',
                createdBy: currentUser.username
            };
            
            if (editingTask) {
                // Update existing task
                const index = tasks.findIndex(t => t.id === editingTask.id);
                tasks[index] = { ...taskData, id: editingTask.id };
                showToast('Task updated successfully', 'success');
            } else {
                // Add new task
                taskData.id = Date.now();
                tasks.push(taskData);
                showToast('Task added successfully', 'success');
            }
            
            // Save to localStorage
            localStorage.setItem('crm_tasks', JSON.stringify(tasks));
            
            // Refresh task lists
            loadTasks();
            loadUpcomingTasks();
            updateTaskNotificationBadge();
            
            // Close modal
            closeTaskModal();
        }

        function completeTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.status = 'completed';
                localStorage.setItem('crm_tasks', JSON.stringify(tasks));
                showToast('Task completed successfully', 'success');
                loadTasks();
                loadUpcomingTasks();
                updateTaskNotificationBadge();
            }
        }

        function deleteTask(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                localStorage.setItem('crm_tasks', JSON.stringify(tasks));
                showToast('Task deleted successfully', 'success');
                loadTasks();
                loadUpcomingTasks();
                updateTaskNotificationBadge();
            }
        }

        function updateTaskNotificationBadge() {
            const pendingTasks = tasks.filter(t => 
                t.status === 'pending' && 
                (t.assignedTo === currentUser.username || t.assignedTo === 'all' || currentUser.role === 'admin')
            ).length;
            
            const badge = document.getElementById('taskNotificationBadge');
            if (pendingTasks > 0) {
                badge.textContent = pendingTasks;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function startTaskReminderChecker() {
            // Check for task reminders every minute
            setInterval(() => {
                const now = new Date();
                tasks.forEach(task => {
                    if (task.status === 'pending' && task.reminder && task.reminder !== 'none') {
                        const dueDate = new Date(task.dueDate);
                        const reminderTime = new Date(dueDate.getTime() - (parseInt(task.reminder) * 60000));
                        
                        if (now >= reminderTime && now < dueDate) {
                            // Show reminder
                            showToast(`Task Reminder: "${task.title}" is due soon!`, 'warning');
                            
                            // Mark reminder as shown to avoid duplicate notifications
                            task.reminderShown = true;
                            localStorage.setItem('crm_tasks', JSON.stringify(tasks));
                        }
                    }
                });
            }, 60000); // Check every minute
        }

        function loadCallHistory() {
            const callHistoryTable = document.getElementById('callHistoryTable');
            const userCallHistory = currentUser.role === 'admin' 
                ? callHistory 
                : callHistory.filter(c => c.user === currentUser.username);
            
            if (userCallHistory.length === 0) {
                callHistoryTable.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No call history found</td></tr>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedHistory = [...userCallHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            callHistoryTable.innerHTML = sortedHistory.map(call => {
                const duration = call.duration ? formatCallDuration(call.duration) : 'N/A';
                const typeIcon = call.type === 'incoming' ? 'fa-phone-alt' : 'fa-phone';
                const typeColor = call.type === 'incoming' ? 'text-blue-600' : 'text-green-600';
                const statusClass = call.status === 'completed' ? 'status-completed' : 
                                   call.status === 'missed' ? 'status-rejected' : 'status-pending';
                
                return `
                    <tr>
                        <td>${new Date(call.timestamp).toLocaleString()}</td>
                        <td>${call.contact}</td>
                        <td>${duration}</td>
                        <td><i class="fas ${typeIcon} ${typeColor}"></i> ${call.type}</td>
                        <td><span class="status-badge ${statusClass}">${call.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function formatCallDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function clearCallHistory() {
            if (confirm('Are you sure you want to clear all call history? This action cannot be undone.')) {
                if (currentUser.role === 'admin') {
                    callHistory = [];
                } else {
                    callHistory = callHistory.filter(c => c.user !== currentUser.username);
                }
                localStorage.setItem('crm_callHistory', JSON.stringify(callHistory));
                showToast('Call history cleared successfully', 'success');
                loadCallHistory();
            }
        }

        function exportCallHistory() {
            const userCallHistory = currentUser.role === 'admin' 
                ? callHistory 
                : callHistory.filter(c => c.user === currentUser.username);
            
            if (userCallHistory.length === 0) {
                showToast('No call history to export', 'warning');
                return;
            }
            
            // Create CSV content
            const csv = [
                ['Date & Time', 'Contact', 'Duration (seconds)', 'Type', 'Status', 'User'],
                ...userCallHistory.map(call => [
                    new Date(call.timestamp).toLocaleString(),
                    call.contact,
                    call.duration || 0,
                    call.type,
                    call.status,
                    call.user
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `call_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Call history exported successfully', 'success');
        }

        function loadFiles() {
            const uploadedFilesList = document.getElementById('uploadedFiles');
            const userFiles = currentUser.role === 'admin' 
                ? uploadedFiles 
                : uploadedFiles.filter(f => f.uploadedBy === currentUser.username);
            
            if (userFiles.length === 0) {
                uploadedFilesList.innerHTML = '<p class="text-gray-500 text-center py-8">No files uploaded</p>';
                return;
            }
            
            uploadedFilesList.innerHTML = userFiles.map(file => `
                <div class="flex items-center justify-between p-4 border rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-file-${getFileIcon(file.type)} text-2xl text-gray-400 mr-3"></i>
                        <div>
                            <p class="font-medium text-gray-900">${file.name}</p>
                            <p class="text-sm text-gray-500">${formatFileSize(file.size)} • ${new Date(file.uploadDate).toLocaleDateString()} • Uploaded by: ${file.uploadedBy}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadFile('${file.name}')" class="btn-secondary text-sm">
                            <i class="fas fa-download"></i>
                        </button>
                        ${file.uploadedBy === currentUser.username || currentUser.role === 'admin' ? `
                            <button onclick="deleteFile(${file.id})" class="btn-secondary text-red-600 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function loadAllLeads() {
            renderLeadsTable('allLeadsTable', leads, false);
        }

        function renderLeadsTable(tableId, leadsData, showCheckbox = false) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            if (leadsData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${showCheckbox ? 8 : 7}" class="text-center py-8 text-gray-500">No leads found</td></tr>`;
                return;
            }
            
            leadsData.forEach(lead => {
                const row = document.createElement('tr');
                let checkboxHtml = showCheckbox ? `<td><input type="checkbox" class="lead-checkbox" value="${lead.id}"></td>` : '';
                
                row.innerHTML = `
                    ${checkboxHtml}
                    <td class="font-medium">${lead.customerName}</td>
                    <td>
                        <div class="text-sm">
                            <div>${lead.email}</div>
                            <div class="text-gray-500">${lead.phone}</div>
                        </div>
                    </td>
                    <td>${getLoanTypeBadge(lead.loanType)}</td>
                    <td>₹${lead.loanAmount.toLocaleString('en-IN')}</td>
                    <td>${getStatusBadge(lead.status)}</td>
                    ${showCheckbox ? `<td>${lead.assignedTo ? agents.find(a => a.username === lead.assignedTo)?.name || 'Unassigned' : 'Unassigned'}</td>` : ''}
                    <td>
                        <div class="action-buttons">
                            <button onclick="openWhatsApp('${lead.phone}', '${lead.customerName}')" class="action-btn btn-whatsapp text-white" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button onclick="makeIVRCall('${lead.phone}', '${lead.customerName}')" class="action-btn btn-call text-white" title="IVR Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button onclick="showClientDocuments(${lead.id})" class="action-btn btn-document text-white" title="Client Documents">
                                <i class="fas fa-file-alt"></i>
                            </button>
                            <button onclick="editLead(${lead.id})" class="action-btn btn-secondary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteLead(${lead.id})" class="action-btn btn-secondary text-red-600" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadAdminData() {
            // Calculate admin metrics
            const totalAgents = agents.length;
            const activeAgents = agents.filter(a => a.status === 'active').length;
            const leadsAssigned = agents.reduce((sum, a) => sum + a.leadsAssigned, 0);
            const leadsConverted = agents.reduce((sum, a) => sum + a.leadsConverted, 0);
            const conversionRate = leadsAssigned > 0 ? Math.round((leadsConverted / leadsAssigned) * 100) : 0;
            
            // Update metrics
            document.getElementById('totalAgents').textContent = totalAgents;
            document.getElementById('activeAgents').textContent = activeAgents;
            document.getElementById('leadsAssigned').textContent = leadsAssigned;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            
            // Render agents table
            const tbody = document.getElementById('agentsTable');
            tbody.innerHTML = '';
            
            agents.forEach(agent => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-medium">${agent.name}</td>
                    <td>${agent.username}</td>
                    <td>
                        <div class="text-sm">
                            <div>${agent.email}</div>
                            <div class="text-gray-500">${agent.phone}</div>
                        </div>
                    </td>
                    <td>${agent.status === 'active' ? '<span class="status-badge status-approved">Active</span>' : '<span class="status-badge status-rejected">Inactive</span>'}</td>
                    <td>
                        <div class="text-sm">
                            <div>${agent.leadsConverted}/${agent.leadsAssigned} leads</div>
                            <div class="text-gray-500">${agent.leadsAssigned > 0 ? Math.round((agent.leadsConverted / agent.leadsAssigned) * 100) : 0}% conversion</div>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="editAgent(${agent.id})" class="action-btn btn-secondary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteAgent(${agent.id})" class="action-btn btn-secondary text-red-600" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Render all leads table for admin
            renderLeadsTable('adminLeadsTable', leads, true);
        }

        function loadReportsData() {
            // Populate agent select for reports
            const reportAgentSelect = document.getElementById('reportAgent');
            reportAgentSelect.innerHTML = '<option value="">All Agents</option>';
            agents.filter(a => a.status === 'active').forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.username;
                option.textContent = agent.name;
                reportAgentSelect.appendChild(option);
            });
            
            // Set today's date as default
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            
            // Load commitments
            loadCommitments();
        }

        function loadCommitments() {
            const commitmentsList = document.getElementById('commitmentsList');
            
            if (commitments.length === 0) {
                commitmentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No commitments found</p>';
                return;
            }
            
            commitmentsList.innerHTML = commitments.map(commitment => {
                const progress = (commitment.currentAmount / commitment.targetAmount) * 100;
                const status = progress >= 100 ? 'met' : 
                              new Date(commitment.dueDate) < new Date() ? 'overdue' : 'pending';
                
                return `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-medium text-gray-900">${commitment.title}</h4>
                            <span class="commitment-status commitment-${status}">
                                ${status === 'met' ? 'Met' : status === 'overdue' ? 'Overdue' : 'Pending'}
                            </span>
                        </div>
                        <div class="mb-3">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Progress: ₹${commitment.currentAmount.toLocaleString('en-IN')} / ₹${commitment.targetAmount.toLocaleString('en-IN')}</span>
                                <span>${Math.round(progress)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500">
                            <span><i class="fas fa-calendar mr-1"></i>Due: ${new Date(commitment.dueDate).toLocaleDateString()}</span>
                            <button onclick="updateCommitmentProgress(${commitment.id})" class="btn-secondary text-xs">
                                Update Progress
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addCommitment() {
            const title = document.getElementById('commitmentTitle').value;
            const targetAmount = parseInt(document.getElementById('commitmentAmount').value);
            const dueDate = document.getElementById('commitmentDueDate').value;
            
            if (!title || !targetAmount || !dueDate) {
                showToast('Please fill in all commitment fields', 'error');
                return;
            }
            
            const commitment = {
                id: Date.now(),
                title,
                targetAmount,
                currentAmount: 0,
                dueDate: new Date(dueDate).toISOString(),
                status: 'pending',
                assignedTo: 'all'
            };
            
            commitments.push(commitment);
            localStorage.setItem('crm_commitments', JSON.stringify(commitments));
            
            // Clear form
            document.getElementById('commitmentTitle').value = '';
            document.getElementById('commitmentAmount').value = '';
            document.getElementById('commitmentDueDate').value = '';
            
            showToast('Commitment added successfully', 'success');
            loadCommitments();
        }

        function updateCommitmentProgress(id) {
            const commitment = commitments.find(c => c.id === id);
            if (commitment) {
                const newAmount = prompt(`Update current amount (Current: ₹${commitment.currentAmount.toLocaleString('en-IN')}):`);
                if (newAmount && !isNaN(newAmount)) {
                    commitment.currentAmount = parseInt(newAmount);
                    localStorage.setItem('crm_commitments', JSON.stringify(commitments));
                    showToast('Commitment progress updated', 'success');
                    loadCommitments();
                }
            }
        }

        function generateDailyReport() {
            const agent = document.getElementById('reportAgent').value;
            const date = document.getElementById('reportDate').value;
            
            if (!date) {
                showToast('Please select a date', 'error');
                return;
            }
            
            // Filter leads for the selected date and agent
            const filteredLeads = leads.filter(lead => {
                const leadDate = new Date(lead.createdDate).toISOString().split('T')[0];
                return leadDate === date && (!agent || lead.assignedTo === agent);
            });
            
            // Filter tasks for the selected date and agent
            const filteredTasks = tasks.filter(task => {
                const taskDate = new Date(task.dueDate).toISOString().split('T')[0];
                return taskDate === date && (!agent || task.assignedTo === agent || task.assignedTo === 'all');
            });
            
            // Generate report content
            const reportContent = `
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4">Daily Worksheet Report</h4>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-600">Date:</p>
                            <p class="font-medium">${new Date(date).toLocaleDateString()}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Agent:</p>
                            <p class="font-medium">${agent ? agents.find(a => a.username === agent)?.name || 'Unknown' : 'All Agents'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border">
                            <p class="text-sm text-gray-600">Total Leads</p>
                            <p class="text-2xl font-bold text-blue-600">${filteredLeads.length}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <p class="text-sm text-gray-600">Completed Tasks</p>
                            <p class="text-2xl font-bold text-green-600">${filteredTasks.filter(t => t.status === 'completed').length}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <p class="text-sm text-gray-600">Total Amount</p>
                            <p class="text-2xl font-bold text-purple-600">₹${filteredLeads.reduce((sum, l) => sum + l.loanAmount, 0).toLocaleString('en-IN')}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h5 class="font-medium mb-2">Leads Summary</h5>
                            <div class="bg-white p-4 rounded-lg border">
                                ${filteredLeads.length > 0 ? `
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="border-b">
                                                <th class="text-left py-2">Customer</th>
                                                <th class="text-left py-2">Amount</th>
                                                <th class="text-left py-2">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${filteredLeads.map(lead => `
                                                <tr class="border-b">
                                                    <td class="py-2">${lead.customerName}</td>
                                                    <td class="py-2">₹${lead.loanAmount.toLocaleString('en-IN')}</td>
                                                    <td class="py-2">${getStatusBadge(lead.status)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p class="text-gray-500">No leads found for this date</p>'}
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-medium mb-2">Tasks Summary</h5>
                            <div class="bg-white p-4 rounded-lg border">
                                ${filteredTasks.length > 0 ? `
                                    <ul class="space-y-2">
                                        ${filteredTasks.map(task => `
                                            <li class="flex justify-between items-center">
                                                <span>${task.title}</span>
                                                <span class="status-badge ${task.status === 'completed' ? 'status-completed' : 'status-pending'}">${task.status}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                ` : '<p class="text-gray-500">No tasks found for this date</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex gap-3">
                        <button onclick="downloadReport('daily', '${date}', '${agent}')" class="btn-primary">
                            <i class="fas fa-download mr-2"></i>Download Report
                        </button>
                        <button onclick="printReport()" class="btn-secondary">
                            <i class="fas fa-print mr-2"></i>Print Report
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('dailyReportContent').innerHTML = reportContent;
            document.getElementById('dailyReportContent').classList.remove('hidden');
        }

        function generatePerformanceReport(type) {
            // Generate performance report based on type (weekly, monthly, custom)
            showToast(`Generating ${type} performance report...`, 'success');
            
            // This would typically generate a detailed performance report
            // For demo purposes, showing a placeholder
            const reportContent = `
                <div class="bg-gray-50 rounded-lg p-6">
                    <h4 class="text-lg font-semibold mb-4">${type.charAt(0).toUpperCase() + type.slice(1)} Performance Report</h4>
                    <p class="text-gray-600">Performance metrics and analytics would be displayed here.</p>
                    <div class="mt-4">
                        <button onclick="downloadReport('performance', '${type}', '')" class="btn-primary">
                            <i class="fas fa-download mr-2"></i>Download Report
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('performanceReportContent').innerHTML = reportContent;
            document.getElementById('performanceReportContent').classList.remove('hidden');
        }

        function downloadReport(type, date, agent) {
            // Create a simple CSV download for demo
            let csvContent = '';
            
            if (type === 'daily') {
                csvContent = `Daily Worksheet Report\nDate: ${date}\nAgent: ${agent || 'All Agents'}\n\n`;
                csvContent += 'Customer,Loan Amount,Status\n';
                
                const filteredLeads = leads.filter(lead => {
                    const leadDate = new Date(lead.createdDate).toISOString().split('T')[0];
                    return leadDate === date && (!agent || lead.assignedTo === agent);
                });
                
                filteredLeads.forEach(lead => {
                    csvContent += `"${lead.customerName}",${lead.loanAmount},${lead.status}\n`;
                });
            }
            
            // Download the CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_report_${date || new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Report downloaded successfully', 'success');
        }

        function printReport() {
            window.print();
        }

        // File Upload Functions
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('fileUploadArea').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('fileUploadArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('fileUploadArea').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`File ${file.name} is too large (max 5MB)`, 'error');
                    return;
                }
                
                // Check file type
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                if (!allowedTypes.includes(file.type)) {
                    showToast(`File ${file.name} is not a supported format`, 'error');
                    return;
                }
                
                // Store file info (in a real app, you'd upload to server)
                const fileInfo = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadDate: new Date().toISOString(),
                    uploadedBy: currentUser.username
                };
                
                uploadedFiles.push(fileInfo);
                localStorage.setItem('crm_files', JSON.stringify(uploadedFiles));
                
                showToast(`File ${file.name} uploaded successfully`, 'success');
            });
            
            loadFiles();
        }

        // Client Documents Functions
        function showClientDocuments(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            
            currentClientLead = lead;
            document.getElementById('clientName').textContent = lead.customerName;
            
            // Load existing documents for this lead
            loadClientDocuments(leadId);
            
            document.getElementById('clientDocumentsModal').classList.add('active');
        }

        function closeClientDocumentsModal() {
            document.getElementById('clientDocumentsModal').classList.remove('active');
            currentClientLead = null;
        }

        function loadClientDocuments(leadId) {
            const documentsList = document.getElementById('clientDocumentsList');
            const leadDocuments = clientDocuments.filter(d => d.leadId === leadId);
            
            if (leadDocuments.length === 0) {
                documentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No documents uploaded for this client</p>';
                return;
            }
            
            documentsList.innerHTML = leadDocuments.map(doc => `
                <div class="document-item">
                    <div class="flex items-center">
                        <i class="fas fa-file-${getFileIcon(doc.type)} text-lg text-gray-400 mr-2"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${doc.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(doc.size)} • ${new Date(doc.uploadDate).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadClientDocument(${doc.id})" class="btn-secondary text-xs">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="deleteClientDocument(${doc.id})" class="btn-secondary text-red-600 text-xs">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function handleClientFileDragOver(e) {
            e.preventDefault();
            document.getElementById('clientFileUploadArea').classList.add('dragover');
        }

        function handleClientFileDragLeave(e) {
            e.preventDefault();
            document.getElementById('clientFileUploadArea').classList.remove('dragover');
        }

        function handleClientFileDrop(e) {
            e.preventDefault();
            document.getElementById('clientFileUploadArea').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            handleClientFiles(files);
        }

        function handleClientFileSelect(e) {
            const files = e.target.files;
            handleClientFiles(files);
        }

        function handleClientFiles(files) {
            if (!currentClientLead) return;
            
            Array.from(files).forEach(file => {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`File ${file.name} is too large (max 5MB)`, 'error');
                    return;
                }
                
                // Check file type
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'image/jpeg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    showToast(`File ${file.name} is not a supported format`, 'error');
                    return;
                }
                
                // Store document info
                const docInfo = {
                    id: Date.now() + Math.random(),
                    leadId: currentClientLead.id,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadDate: new Date().toISOString(),
                    uploadedBy: currentUser.username
                };
                
                clientDocuments.push(docInfo);
                localStorage.setItem('crm_clientDocuments', JSON.stringify(clientDocuments));
                
                showToast(`Document ${file.name} uploaded successfully for ${currentClientLead.customerName}`, 'success');
            });
            
            // Reload documents list
            loadClientDocuments(currentClientLead.id);
        }

        function downloadClientDocument(docId) {
            const doc = clientDocuments.find(d => d.id === docId);
            if (doc) {
                // In a real app, this would download the actual file
                showToast(`Downloading ${doc.name}...`, 'success');
            }
        }

        function deleteClientDocument(docId) {
            if (confirm('Are you sure you want to delete this document?')) {
                clientDocuments = clientDocuments.filter(d => d.id !== docId);
                localStorage.setItem('crm_clientDocuments', JSON.stringify(clientDocuments));
                showToast('Document deleted successfully', 'success');
                loadClientDocuments(currentClientLead.id);
            }
        }

        function getFileIcon(type) {
            if (type.includes('pdf')) return 'pdf';
            if (type.includes('word')) return 'word';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'excel';
            if (type.includes('image')) return 'image';
            return 'alt';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(filename) {
            // In a real app, this would download the actual file
            showToast(`Downloading ${filename}...`, 'success');
        }

        function deleteFile(id) {
            if (confirm('Are you sure you want to delete this file?')) {
                uploadedFiles = uploadedFiles.filter(f => f.id !== id);
                localStorage.setItem('crm_files', JSON.stringify(uploadedFiles));
                showToast('File deleted successfully', 'success');
                loadFiles();
            }
        }

        // Dial Pad Functions
        function showDialPad() {
            dialPadNumber = '';
            updateDialDisplay();
            document.getElementById('dialPadModal').classList.add('active');
        }

        function closeDialPad() {
            document.getElementById('dialPadModal').classList.remove('active');
        }

        function dialPadInput(digit) {
            dialPadNumber += digit;
            updateDialDisplay();
        }

        function updateDialDisplay() {
            const display = document.getElementById('dialDisplay');
            if (dialPadNumber) {
                display.textContent = formatPhoneNumber(dialPadNumber);
            } else {
                display.textContent = 'Enter number';
            }
        }

        function formatPhoneNumber(number) {
            // Simple formatting for Indian numbers
            if (number.startsWith('91') && number.length === 12) {
                return '+' + number.slice(0, 2) + ' ' + number.slice(2, 7) + ' ' + number.slice(7);
            }
            if (number.length === 10) {
                return '+91 ' + number.slice(0, 5) + ' ' + number.slice(5);
            }
            return number;
        }

        function clearDialPad() {
            dialPadNumber = '';
            updateDialDisplay();
        }

        function makeDialPadCall() {
            if (!dialPadNumber) {
                showToast('Please enter a phone number', 'error');
                return;
            }
            
            const formattedNumber = dialPadNumber.startsWith('+') ? dialPadNumber : '+91' + dialPadNumber;
            makeIVRCall(formattedNumber, 'Dial Pad Contact');
            closeDialPad();
        }

        function updateProfilePage() {
            // Update profile information
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileRole').textContent = currentUser.role === 'admin' ? 'Administrator' : 'Agent';
            document.getElementById('profileRole').className = `status-badge ${currentUser.role === 'admin' ? 'status-approved' : 'status-new'}`;
            document.getElementById('profileEmailDetail').textContent = currentUser.email;
            document.getElementById('profilePhone').textContent = currentUser.phone;
            
            // Update initials
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('profileInitials').textContent = initials;
            
            // Update form inputs
            document.getElementById('profileNameInput').value = currentUser.name;
            document.getElementById('profileEmailInput').value = currentUser.email;
            document.getElementById('profilePhoneInput').value = currentUser.phone;
        }

        function handleProfileUpdate(e) {
            e.preventDefault();
            
            currentUser.name = document.getElementById('profileNameInput').value;
            currentUser.email = document.getElementById('profileEmailInput').value;
            currentUser.phone = document.getElementById('profilePhoneInput').value;
            
            localStorage.setItem('crm_user', JSON.stringify(currentUser));
            
            // Update UI
            document.getElementById('userName').textContent = currentUser.name;
            updateProfilePage();
            
            showToast('Profile updated successfully', 'success');
        }

        function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            // In a real app, this would update the password in the backend
            showToast('Password changed successfully', 'success');
            
            // Reset form
            document.getElementById('passwordForm').reset();
        }

        function showAddLeadModal() {
            editingLead = null;
            document.getElementById('leadModalTitle').textContent = 'Add New Lead';
            document.getElementById('leadForm').reset();
            
            // Show agent assignment field for admin
            if (currentUser.role === 'admin') {
                document.getElementById('agentAssignField').classList.remove('hidden');
                populateAgentSelect();
            } else {
                document.getElementById('agentAssignField').classList.add('hidden');
            }
            
            document.getElementById('leadModal').classList.add('active');
        }

        function populateAgentSelect() {
            const select = document.getElementById('leadAgent');
            select.innerHTML = '<option value="">Select Agent</option>';
            
            agents.filter(a => a.status === 'active').forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.username;
                option.textContent = agent.name;
                select.appendChild(option);
            });
        }

        function editLead(id) {
            editingLead = leads.find(l => l.id === id);
            if (editingLead) {
                document.getElementById('leadModalTitle').textContent = 'Edit Lead';
                document.getElementById('leadName').value = editingLead.customerName;
                document.getElementById('leadEmail').value = editingLead.email;
                document.getElementById('leadPhone').value = editingLead.phone;
                document.getElementById('leadAmount').value = editingLead.loanAmount;
                document.getElementById('leadType').value = editingLead.loanType;
                document.getElementById('leadStatus').value = editingLead.status;
                document.getElementById('leadNotes').value = editingLead.notes || '';
                
                // Show agent assignment field for admin
                if (currentUser.role === 'admin') {
                    document.getElementById('agentAssignField').classList.remove('hidden');
                    populateAgentSelect();
                    document.getElementById('leadAgent').value = editingLead.assignedTo || '';
                } else {
                    document.getElementById('agentAssignField').classList.add('hidden');
                }
                
                document.getElementById('leadModal').classList.add('active');
            }
        }

        function closeLeadModal() {
            document.getElementById('leadModal').classList.remove('active');
            editingLead = null;
        }

        function handleLeadSubmit(e) {
            e.preventDefault();
            
            const leadData = {
                customerName: document.getElementById('leadName').value,
                email: document.getElementById('leadEmail').value,
                phone: document.getElementById('leadPhone').value,
                loanAmount: parseInt(document.getElementById('leadAmount').value),
                loanType: document.getElementById('leadType').value,
                status: document.getElementById('leadStatus').value,
                notes: document.getElementById('leadNotes').value,
                createdDate: editingLead ? editingLead.createdDate : new Date().toISOString(),
                assignedTo: currentUser.role === 'admin' ? document.getElementById('leadAgent').value : currentUser.username
            };
            
            if (editingLead) {
                // Update existing lead
                const index = leads.findIndex(l => l.id === editingLead.id);
                leads[index] = { ...leadData, id: editingLead.id };
                showToast('Lead updated successfully', 'success');
            } else {
                // Add new lead
                leadData.id = Date.now();
                leads.push(leadData);
                showToast('Lead added successfully', 'success');
            }
            
            // Save to localStorage
            localStorage.setItem('crm_leads', JSON.stringify(leads));
            
            // Refresh tables
            loadDashboardData();
            loadAllLeads();
            if (currentUser.role === 'admin') {
                loadAdminData();
            }
            
            // Close modal
            closeLeadModal();
        }

        function deleteLead(id) {
            if (confirm('Are you sure you want to delete this lead?')) {
                leads = leads.filter(l => l.id !== id);
                localStorage.setItem('crm_leads', JSON.stringify(leads));
                showToast('Lead deleted successfully', 'success');
                loadDashboardData();
                loadAllLeads();
                if (currentUser.role === 'admin') {
                    loadAdminData();
                }
            }
        }

        function filterLeads(query) {
            const filteredLeads = leads.filter(lead => 
                lead.customerName.toLowerCase().includes(query.toLowerCase()) ||
                lead.email.toLowerCase().includes(query.toLowerCase()) ||
                lead.phone.includes(query)
            );
            renderLeadsTable('allLeadsTable', filteredLeads, false);
        }

        function showAddAgentModal() {
            editingAgent = null;
            document.getElementById('agentModalTitle').textContent = 'Add New Agent';
            document.getElementById('agentForm').reset();
            document.getElementById('agentModal').classList.add('active');
        }

        function editAgent(id) {
            editingAgent = agents.find(a => a.id === id);
            if (editingAgent) {
                document.getElementById('agentModalTitle').textContent = 'Edit Agent';
                document.getElementById('agentName').value = editingAgent.name;
                document.getElementById('agentUsername').value = editingAgent.username;
                document.getElementById('agentEmail').value = editingAgent.email;
                document.getElementById('agentPhone').value = editingAgent.phone;
                document.getElementById('agentStatus').value = editingAgent.status;
                document.getElementById('agentPassword').value = '';
                document.getElementById('agentModal').classList.add('active');
            }
        }

        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('active');
            editingAgent = null;
        }

        function handleAgentSubmit(e) {
            e.preventDefault();
            
            const agentData = {
                name: document.getElementById('agentName').value,
                username: document.getElementById('agentUsername').value,
                email: document.getElementById('agentEmail').value,
                phone: document.getElementById('agentPhone').value,
                status: document.getElementById('agentStatus').value,
                role: 'agent',
                joinDate: editingAgent ? editingAgent.joinDate : new Date().toISOString().split('T')[0],
                leadsAssigned: editingAgent ? editingAgent.leadsAssigned : 0,
                leadsConverted: editingAgent ? editingAgent.leadsConverted : 0
            };
            
            if (editingAgent) {
                // Update existing agent
                const index = agents.findIndex(a => a.id === editingAgent.id);
                agents[index] = { ...agentData, id: editingAgent.id };
                showToast('Agent updated successfully', 'success');
            } else {
                // Add new agent
                const password = document.getElementById('agentPassword').value;
                if (!password) {
                    showToast('Password is required for new agents', 'error');
                    return;
                }
                agentData.id = Date.now();
                agents.push(agentData);
                showToast('Agent added successfully', 'success');
            }
            
            // Save to localStorage
            localStorage.setItem('crm_agents', JSON.stringify(agents));
            
            // Refresh admin data
            loadAdminData();
            
            // Close modal
            closeAgentModal();
        }

        function deleteAgent(id) {
            if (confirm('Are you sure you want to delete this agent? This will also remove their login access.')) {
                agents = agents.filter(a => a.id !== id);
                localStorage.setItem('crm_agents', JSON.stringify(agents));
                showToast('Agent deleted successfully', 'success');
                loadAdminData();
            }
        }

        function openWhatsApp(phone, name) {
            const message = encodeURIComponent(`Hello ${name}, regarding your loan application with Loan Leads CRM...`);
            window.open(`https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${message}`, '_blank');
        }

        function makeIVRCall(phone, name) {
            // Create call record
            currentCall = {
                id: Date.now(),
                contact: `${name} (${phone})`,
                phone: phone,
                name: name,
                timestamp: new Date().toISOString(),
                type: 'outgoing',
                status: 'connected',
                user: currentUser.username,
                duration: 0
            };
            
            // Show call modal
            document.getElementById('callingNumber').textContent = currentCall.contact;
            document.getElementById('callModal').classList.add('active');
            
            // Start call timer
            callStartTime = Date.now();
            callTimer = setInterval(updateCallDuration, 1000);
            
            showToast(`Initiating IVR call to ${name}...`, 'success');
        }

        function updateCallDuration() {
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            currentCall.duration = elapsed;
            document.getElementById('callDuration').textContent = formatCallDuration(elapsed);
        }

        function endCall() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Update call record
            if (currentCall) {
                currentCall.status = 'completed';
                currentCall.endTime = new Date().toISOString();
                
                // Add to call history
                callHistory.push(currentCall);
                localStorage.setItem('crm_callHistory', JSON.stringify(callHistory));
                
                currentCall = null;
            }
            
            document.getElementById('callModal').classList.remove('active');
            document.getElementById('callDuration').textContent = '00:00';
            showToast('Call ended', 'success');
        }

        function transferCall() {
            if (currentCall) {
                currentCall.status = 'transferred';
                showToast('Call transferred to senior agent', 'success');
            }
        }

        function recordCall() {
            if (currentCall) {
                currentCall.recorded = true;
                showToast('Call recording started', 'success');
            }
        }

        function toggleSelectAllLeads() {
            const selectAll = document.getElementById('selectAllLeads');
            const checkboxes = document.querySelectorAll('.lead-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function exportLeads() {
            const selectedLeads = [];
            document.querySelectorAll('.lead-checkbox:checked').forEach(checkbox => {
                const leadId = parseInt(checkbox.value);
                const lead = leads.find(l => l.id === leadId);
                if (lead) selectedLeads.push(lead);
            });
            
            if (selectedLeads.length === 0) {
                showToast('Please select leads to export', 'warning');
                return;
            }
            
            // Create CSV content
            const csv = [
                ['Customer Name', 'Email', 'Phone', 'Loan Type', 'Amount', 'Status', 'Date'],
                ...selectedLeads.map(lead => [
                    lead.customerName,
                    lead.email,
                    lead.phone,
                    lead.loanType,
                    lead.loanAmount,
                    lead.status,
                    new Date(lead.createdDate).toLocaleDateString()
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `leads_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast(`${selectedLeads.length} leads exported successfully`, 'success');
        }

        function bulkDeleteLeads() {
            const selectedLeads = [];
            document.querySelectorAll('.lead-checkbox:checked').forEach(checkbox => {
                const leadId = parseInt(checkbox.value);
                selectedLeads.push(leadId);
            });
            
            if (selectedLeads.length === 0) {
                showToast('Please select leads to delete', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedLeads.length} leads? This action cannot be undone.`)) {
                leads = leads.filter(l => !selectedLeads.includes(l.id));
                localStorage.setItem('crm_leads', JSON.stringify(leads));
                showToast(`${selectedLeads.length} leads deleted successfully`, 'success');
                loadAdminData();
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'new': '<span class="status-badge status-new">New</span>',
                'in-progress': '<span class="status-badge status-in-progress">In Progress</span>',
                'approved': '<span class="status-badge status-approved">Approved</span>',
                'pending': '<span class="status-badge status-pending">Pending</span>',
                'rejected': '<span class="status-badge status-rejected">Rejected</span>'
            };
            return badges[status] || status;
        }

        function getLoanTypeBadge(type) {
            const badges = {
                'home': '<span class="loan-type-badge loan-home"><i class="fas fa-home mr-1"></i>Home Loan</span>',
                'personal': '<span class="loan-type-badge loan-personal"><i class="fas fa-user mr-1"></i>Personal</span>',
                'business': '<span class="loan-type-badge loan-business"><i class="fas fa-briefcase mr-1"></i>Business</span>',
                'car': '<span class="loan-type-badge loan-car"><i class="fas fa-car mr-1"></i>Car Loan</span>',
                'education': '<span class="loan-type-badge loan-education"><i class="fas fa-graduation-cap mr-1"></i>Education</span>'
            };
            return badges[type] || type;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('i');
            
            // Update toast content
            toastMessage.textContent = message;
            
            // Update toast type
            toast.className = 'toast show ' + type;
            
            // Update icon
            icon.className = type === 'success' ? 'fas fa-check-circle text-green-500' :
                           type === 'error' ? 'fas fa-exclamation-circle text-red-500' :
                           'fas fa-exclamation-triangle text-yellow-500';
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>

<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>

